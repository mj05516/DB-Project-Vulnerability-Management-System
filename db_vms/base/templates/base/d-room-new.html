{% extends "main.html" %}

{% load static %}



{% block content %}
<link href="{% static 'assets/lib/emojionearea/emojionearea.min.css'%}" rel="stylesheet">
<script src="{% static 'assets/lib/emojionearea/emojionearea.min.js'%}"></script>

<style>
  .wrapper{
    z-index: 99 !important;
  }
  .chat-message {
    font-size: 16px !important;
    }
</style>

<div class="card card-chat overflow-hidden">
  <div class="card-body d-flex p-0 h-100">
     <div class="tab-content card-chat-content">
      <div class="tab-pane card-chat-pane active" id="chat-0" role="tabpanel" aria-labelledby="chat-link-0">
        <div class="chat-content-header">
          <div class="row flex-between-center">
            <div class="col-6 col-sm-8 d-flex align-items-center"><a class="pe-3 text-700 d-md-none contacts-list-show"
                href="#!">
                <div class="fas fa-chevron-left"></div>
              </a>
              <div class="min-w-0">
                <h5 class="mb-0 text-truncate fs-0">{{room.title}}</h5>
                <div class="fs--2 text-400">created by @{{room.host}}
                </div>
              </div>
            </div>
            <div class="col-auto">
              <!-- <button class="btn btn-sm btn-falcon-primary me-2" type="button" data-index="0" data-bs-toggle="tooltip"
                data-bs-placement="top" title="Start a Call"><span class="fas fa-phone"></span></button>
              <button class="btn btn-sm btn-falcon-primary me-2" type="button" data-index="0" data-bs-toggle="tooltip"
                data-bs-placement="top" title="Start a Video Call"><span class="fas fa-video"></span></button> -->
              <button class="btn btn-sm btn-falcon-primary btn-info" type="button" data-index="0"
                data-bs-toggle="tooltip" data-bs-placement="top" title="Conversation Information"><span
                  class="fas fa-info"></span></button>
            </div>
          </div>
        </div>
        <div class="chat-content-body" style="display: inherit;">
          <div class="conversation-info" data-index="0">
            <div class="h-100 overflow-auto scrollbar">
              <div class="d-flex position-relative align-items-center p-3 border-bottom">
                <!-- <div class="avatar avatar-xl status-online">
                    <img class="rounded-circle" src="/static/assets/img/team/avatar.png" alt="">

                  </div> -->
                <div class="flex-1 ms-2 d-flex flex-between-center">
                  <h6 class="mb-0"><a class="text-decoration-none stretched-link text-700"
                      href="#!">{{room.title}}</a><br>
                    <a class="text-decoration-none stretched-link text-700" href="" style="font-size: 11px;">Created
                      {{room.created_at|timesince}} ago</a>
                  </h6>

                  {% if room.host == request.user or request.user.is_superuser %}
                  <div class="dropdown z-index-1">
                    <button class="btn btn-link btn-sm text-400 dropdown-toggle dropdown-caret-none me-n3" type="button"
                      id="profile-dropdown-0" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span
                        class="fas fa-cog"></span></button>
                    <div class="dropdown-menu dropdown-menu-end border py-2" aria-labelledby="profile-dropdown-0">
                      <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#edit-discussion-room-modal" href="#!">Edit</a>
                      
                      <a class="dropdown-item text-danger" href="{% url 'delete_room' room.id %}">Delete</a>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
              <!-- <div class="px-3 pt-2">
                <div class="nav flex-column font-sans-serif fw-medium"><a
                    class="nav-link d-flex align-items-center py-1 px-0 text-600" href="#!"><span
                      class="conversation-info-icon"><span class="fas fa-search me-1"
                        data-fa-transform="shrink-1 down-3"></span></span>Search in Conversation</a><a
                    class="nav-link d-flex align-items-center py-1 px-0 text-600" href="#!"><span
                      class="conversation-info-icon"><span class="fas fa-pencil-alt me-1"
                        data-fa-transform="shrink-1"></span></span>Edit Nicknames</a><a
                    class="nav-link d-flex align-items-center py-1 px-0 text-600" href="#!"><span
                      class="conversation-info-icon"><span class="fas fa-palette me-1"
                        data-fa-transform="shrink-1"></span></span><span>Change Color</span></a><a
                    class="nav-link d-flex align-items-center py-1 px-0 text-600" href="#!"><span
                      class="conversation-info-icon"><span class="fas fa-thumbs-up me-1"
                        data-fa-transform="shrink-1"></span></span>Change Emoji</a><a
                    class="nav-link d-flex align-items-center py-1 px-0 text-600" href="#!"><span
                      class="conversation-info-icon"><span class="fas fa-bell me-1"
                        data-fa-transform="shrink-1"></span></span>Notifications</a>
                      </div>
              </div>
              <hr class="my-2" /> -->

              <div class="px-3 pt-2" id="others-info-0">
                <div class="title" id="shared-media-title-0"><a
                    class="btn btn-link btn-accordion hover-text-decoration-none dropdown-indicator"
                    href="#shared-media-0" data-bs-toggle="collapse" aria-expanded="false"
                    aria-controls="shared-media-0">Topic</a></div>
                <div class="collapse" id="shared-media-0" aria-labelledby="shared-media-title-0"
                  data-parent="#others-info-0">
                  {{room.topic}}
                </div>
              </div>
              <hr class="my-2" />
              <div class="px-3" id="others-info-0">
                <div class="title" id="shared-media-title-0"><a
                    class="btn btn-link btn-accordion hover-text-decoration-none dropdown-indicator"
                    href="#shared-media-1" data-bs-toggle="collapse" aria-expanded="false"
                    aria-controls="shared-media-0">Description</a></div>
                <div class="collapse" id="shared-media-1" aria-labelledby="shared-media-title-0"
                  data-parent="#others-info-0">
                  {{room.description}}
                </div>
              </div>
              <hr class="my-2" />
              <div class="px-3" id="others-info-0">
                <div class="title" id="shared-media-title-0"><a
                    class="btn btn-link btn-accordion hover-text-decoration-none dropdown-indicator"
                    href="#shared-media-9" data-bs-toggle="collapse" aria-expanded="false"
                    aria-controls="shared-media-9">CVEs</a></div>
                <div class="collapse" id="shared-media-9" aria-labelledby="shared-media-title-0"
                  data-parent="#others-info-0">
                  <ul>
                  {% for c in cves %}
                  <li>
                    <a href="#">{{c.cve_id}}</a>
                  </li>
                    {% endfor %}
                </ul>
                </div>
              </div>
              <hr class="my-2" />
              <div class="px-3" id="others-info-0">
                <div class="title" id="shared-media-title-0"><a
                    class="btn btn-link btn-accordion hover-text-decoration-none dropdown-indicator"
                    href="#shared-media-2" data-bs-toggle="collapse" aria-expanded="false"
                    aria-controls="shared-media-0">Members</a></div>
                <div class="collapse" id="shared-media-2" aria-labelledby="shared-media-title-0"
                  data-parent="#others-info-0">
                  <ul style="list-style: none; padding-left: 0;">
                    {% for member in members %}

                    <!-- check if member is host -->
                    {% if member.id == room.host_id %}
                    <li>
                      <div style="position: relative;
                      top: 11px;" class="avatar avatar-xl ">
                        <img class="rounded-circle" src="/static/assets/img/team/avatar.png" alt="">
                      </div>
                      <a href="#">{{member.username}}</a> (Host)
                    </li>
                    {% else %}
                    <li>
                      <div style="position: relative;
                      top: 11px;" class="avatar avatar-xl status-online">
                        <img class="rounded-circle" src="/static/assets/img/team/avatar.png" alt="">
                      </div>
                      <a href="#">{{member.username}}</a>
                    </li>
                    {% endif %}

                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div class="chat-content-scroll-area scrollbar" id="chat-area">

            <!-- {% with time=room.created_at %} -->

            <!-- <script>
              console.log("{{time}}")
            </script> -->

            <!-- show date in every change of dd of next msg-->


            <!-- {% if message.timestamp|date:"Y-m-d" != time|date:"Y-m-d" %} -->

            <!-- <script>
              console.log('{{message.timestamp|date:"Y-m-d"}}')
            </script> -->

            <!-- <div class="text-center fs--2 text-500"><span>{{message.timestamp}}</span></div>
            {% with time=message.timestamp %}
            {% endwith %}
            {% endif %} -->

            {% if message.user == user %}
            <!-- <div class="d-flex p-3">
              <div class="flex-1 d-flex justify-content-end">
                <div class="w-100 w-xxl-75">
                  <div class="hover-actions-trigger d-flex flex-end-center">
                    <ul class="hover-actions position-relative list-inline mb-0 text-400 me-2">
                      <li class="list-inline-item"><a class="chat-option" href="#!" data-bs-toggle="tooltip"
                          data-bs-placement="top" title="Forward"><span class="fas fa-share"></span></a></li>
                      <li class="list-inline-item"><a class="chat-option" href="#!" data-bs-toggle="tooltip"
                          data-bs-placement="top" title="Archive"><span class="fas fa-archive"></span></a></li>
                      <li class="list-inline-item"><a class="chat-option" href="#!" data-bs-toggle="tooltip"
                          data-bs-placement="top" title="Edit"><span class="fas fa-edit"></span></a></li>
                      {% if message.user == request.user or room.host == request.user or request.user.is_superuser %}
                      <form method="POST" action="{% url 'delete_message' message.id %}">
                        {% csrf_token %}
                        <li class="list-inline-item"><a class="chat-option" value="Delete"
                            href="{% url 'delete_message' message.id %}" data-bs-toggle="tooltip"
                            data-bs-placement="top" title="Remove"><span class="fas fa-trash-alt"></span></a></li>
                      </form>
                      {% endif %}
                    </ul>
                    <div class="bg-primary text-white p-2 rounded-2 chat-message light">
                      <p class="mb-0">{{message.message}}</p>

                    </div>
                  </div>
                  <div class="text-400 fs--2 text-end">{{message.timestamp|date:"H:i"}}<span
                      class="fas fa-check ms-2 text-success"></span>
                  </div>
                </div>
              </div>
            </div> -->
            {% else %}
            <!-- 
            <div class="d-flex p-3">
              <div class="avatar avatar-l me-2">
                <img class="rounded-circle" src="/static/assets/img/team/avatar.png" alt="">

              </div>
              <div class="flex-1">
                <div class="w-xxl-75">
                  <div class="hover-actions-trigger d-flex align-items-center">
                    <div class="chat-message bg-200 p-2 rounded-2">{{message.message}}</div>
                    <ul class="hover-actions position-relative list-inline mb-0 text-400 ms-2">
                      <li class="list-inline-item"><a class="chat-option" href="#!" data-bs-toggle="tooltip"
                          data-bs-placement="top" title="Forward"><span class="fas fa-share"></span></a></li>
                      <li class="list-inline-item"><a class="chat-option" href="#!" data-bs-toggle="tooltip"
                          data-bs-placement="top" title="Archive"><span class="fas fa-archive"></span></a></li>
                      <li class="list-inline-item"><a class="chat-option" href="#!" data-bs-toggle="tooltip"
                          data-bs-placement="top" title="Edit"><span class="fas fa-edit"></span></a></li>
                      <li class="list-inline-item"><a class="chat-option" href="#!" data-bs-toggle="tooltip"
                          data-bs-placement="top" title="Remove"><span class="fas fa-trash-alt"></span></a></li>
                    </ul>
                  </div>
                  <div class="text-400 fs--2"><span class="fw-semi-bold me-2">{{message.user}}</span><span>
                      
                      {{message.timestamp|date:"H:i"}}
                    </span>
                  </div>
                </div>
              </div>
            </div> -->
            {% endif %}

            {% endwith %}






          </div>
        </div>
      </div>
      {% if room.host == user or user in room.members.all or user.is_superuser %}
      <form class="chat-editor-area" method="POST">
        {% csrf_token %}
        
        <textarea
          class="emojiarea-editor outline-none scrollbar shadow-none form-control rounded-1 resize-none px-card border-200"
          name="body" contenteditable="true" id="message-body" value=""></textarea>
        <!-- <input class="d-none" type="file" id="chat-file-upload" /> -->
        <!-- <label class="chat-file-upload cursor-pointer" for="chat-file-upload"><span class="fas fa-paperclip"></span></label> -->
        <div class="btn btn-link emoji-icon" id="emoji-button"><span
            class="far fa-laugh-beam"></span></div>
        <button id="send" class="btn btn-sm btn-send" type="submit" style="color: #3c5a99;">Send</button>
        <script>
          // check if message-body is empty and keep send disabled using jquery
          $(document).ready(function () {
            $("#send").prop("disabled", true);
            $("#message-body").keyup(function () {
              if ($(this).val().length != 0)
                $("#send").prop("disabled", false);
              else
                $("#send").prop("disabled", true);
            });
          });
        </script>
      </form>
      {% endif %}

    </div>
  </div>
</div>


<!-- End Prev MEssages -->

<div class="modal fade" id="edit-discussion-room-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 50rem">
      <div class="modal-content position-relative">
        <div class="position-absolute top-0 end-0 mt-2 me-2 z-index-1">
        </div>
        <form action="{% url 'edit_room' %}" method="POST">
          {% csrf_token %}
          <div class="modal-body p-0">
            <div class="rounded-top-lg py-3 ps-4 pe-6 bg-light">
              <h4 class="mb-0 txt-hbl" id="modalExampleDemoLabel"><span class="fas fa-comments me-3"></span>
                Edit Discussion Room
            </h4>
            </div>
            <input type="hidden" name="room_id" value="{{room.id}}">
            <div class="p-4 pb-0">
              <div class="row g-3">
                <div class="col-12">
                  <div class="mb-3">
                    <label class="form-label required" for="title">Room Title</label>
                    <input class="form-control" id="title" name="title" type="text" placeholder="Enter Room Title"
                      value="{{room.title}}" required />
                  </div>
                </div>
                
              </div>
  
              <div class="row g-3">
                <div class="col-12">
                  <div class="mb-3">
                    <label for="members">Members</label>
                    <select class="form-select js-choice" id="members" multiple="multiple" size="1" name="members" data-options='{"removeItemButton":true,"placeholder":true}'>
                    <option value="">Select Members...</option>
                    {% for x in usrs %}
                    <option value="{{x.id}}" {% if x in room.members.all %} selected {% endif %} >{{x.username}}</option>
                    {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
            
              <div class="row g-3">
                <div class="col-12">
                  <div class="mb-3">
                    <!-- Textarea for CVE description -->
                    <label class="form-label required" for="description">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="Enter Room Description" required>{{room.description}}</textarea>
                  </div>
                </div>
                
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-sm btn-falcon-default me-1" type="button" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-sm btn-outline-hbl" type="submit">
                <span class="fas fa-plus-circle me-1"></span>
                Edit Room
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  




<script>
  {% if room.host == user or user in room.members.all or user.is_superuser %}
  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  const button = document.querySelector('#emoji-button');
  const picker = new EmojiButton(
    {
      theme: currentTheme == 'dark' ? 'dark' : 'light',
      showPreview: false,
      autoHide: false
    }
  );
  button.addEventListener('click', () => {
    picker.togglePicker(button);

  });
  picker.on('emoji', emoji => {
    document.querySelector('#message-body').value += emoji;
  });
  // get "wrapper" class and add to its style using jquery
  {% endif %}
  $(document).ready(function () {
    $(".wrapper").css("z-index", "9 !important");
  });


  // make a ajax request to get message
  $(document).ready(function getMessages() {
    $.ajax({
      url: "{% url 'get_messages' pk=room.id %}",
      type: "GET",
      success: function (data) {
        var timeStampDate = data.messages[0].timestamp.slice(0, 10);
        var timeStampDate1 = new Date(data.messages[0].timestamp.slice(0, 10));
        var dateInWords = timeStampDate1.toDateString();
        $('#chat-area').append(
          '<div class="text-center fs--2 text-500"><span>'+ dateInWords +'</span></div>'
        )
        for (let i = 0; i < data.messages.length; i++) {
          var time = new Date(data.messages[i].timestamp);
          var time = time.toTimeString()
          var time = time.slice(0, 5)
          if (timeStampDate != data.messages[i].timestamp.slice(0, 10)) {
            var timeStampDate1 = new Date(data.messages[i].timestamp.slice(0, 10));
            var timeStampDate = data.messages[i].timestamp.slice(0, 10);
            var dateInWords = timeStampDate1.toDateString();
            // get time only
            
            $('#chat-area').append(
              '<div class="text-center fs--2 text-500"><span>'+ dateInWords +'</span></div>'
            )
          }
          if (data.messages[i].user_id.toString() == "{{user.id}}") {
            var messageid = data.messages[i].id.toString();
            var messageContent = data.messages[i].message;
            var messageTime = data.messages[i].timestamp;
            var messageTime = messageTime.slice(11, 16);
            var messageUser = data.messages[i].user_id;
            for (let j = 0; j < data.usr.length; j++) {
              if (data.usr[j].id.toString() == messageUser.toString()) {
                var messageUsername = data.usr[j].username;
              }
            }
            
            // value="` +data.messages[i].id+`"
            $("#chat-area").append(
              `<div class="d-flex p-3">
              <div class="flex-1 d-flex justify-content-end">
                <div class="w-100 w-xxl-75">
                  <div class="hover-actions-trigger d-flex flex-end-center">
                    <ul class="hover-actions position-relative list-inline mb-0 text-400 me-2">
                      {% if message.user == request.user or room.host == request.user or request.user.is_superuser %}
                      <form method="POST" action="">
                        {% csrf_token %}
                        <li class="list-inline-item"><a class="chat-option" id="del-msg" value="` +data.messages[i].id+`"
                            href="" data-bs-toggle="tooltip"
                            data-bs-placement="top" title="Remove"><span class="fas fa-trash-alt"></span></a></li>
                      </form>
                      {% endif %}
                    </ul>
                    <div class="bg-primary text-white p-2 rounded-2 chat-message light">
                      <p class="mb-0">`+ data.messages[i].message + `</p>

                    </div>
                  </div>
                  <div class="text-400 fs--2 text-end">`+ time+`<span
                      class="fas fa-check ms-2 text-success"></span>
                  </div>
                </div>
              </div>
            </div>`
            );
          } else {
            var messageid = data.messages[i].id.toString();
            var messageContent = data.messages[i].message;
            var messageTime = data.messages[i].timestamp;
            var messageTime = messageTime.slice(11, 16);
            var messageUser = data.messages[i].user_id;
            for (let j = 0; j < data.usr.length; j++) {
              if (data.usr[j].id.toString() == messageUser.toString()) {
                var messageUsername = data.usr[j].username;
              }
            }

            // check if message id is equal to host id
            if (data.messages[i].user_id.toString() == "{{room.host.id}}") {
              var messageUsername = "{{room.host.username}}";
            }

            // add message to the id #chat-area
            $("#chat-area").append(
              `
              <div class="d-flex p-3">
              <div class="avatar avatar-l me-2">
                <img class="rounded-circle" src="/static/assets/img/team/avatar.png" alt="">

              </div>
              <div class="flex-1">
                <div class="w-xxl-75">
                  <div class="hover-actions-trigger d-flex align-items-center">
                    <div class="chat-message bg-200 p-2 rounded-2">`+ data.messages[i].message + `</div>
                    <ul class="hover-actions position-relative list-inline mb-0 text-400 ms-2">
                      {% if message.user == request.user or room.host == request.user or request.user.is_superuser %}
                      <form method="POST" action="">
                        {% csrf_token %}
                        <li class="list-inline-item"><a class="chat-option" id="del-msg" value="` +data.messages[i].id+`"
                            href="" data-bs-toggle="tooltip"
                            data-bs-placement="top" title="Remove"><span class="fas fa-trash-alt"></span></a></li>
                      </form>
                      {% endif %}
                    </ul>
                  </div>
                  <div class="text-400 fs--2"><span class="fw-semi-bold me-2">`+ messageUsername +`</span><span>
                      
                      `+  time+`
                    </span>
                  </div>
                </div>
              </div>
            </div>
              `
            );
          }

        }
      },
      complete: function () {
        // Schedule the next request when a new message is received
        // setTimeout(getMessages, 1000);
      
      }

    });
  })

  // delete message using value 
  $(document).on('click', '#del-msg', function (e) {
    e.preventDefault();
    var messageid = $(this).attr('value');
    console.log(messageid);
    $.ajax({
      url: "{% url 'delete_message'%}",
      type: "POST",
      data: {
        'messageid': messageid,
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      },
      success: function (data) {
        console.log(data);
        // reload the page
        location.reload();

      }
    });
  });

//   make a ajax request to get all the CVEs
    $(document).ready(function getCVEs() {
    $.ajax({
        url: "{% url 'get_cves' pk=room.id %}",
        type: "GET",
        success: function (data) {
        console.log(data);
        for (let i = 0; i < data.cves.length; i++) {
            var cveid = data.cves[i].id.toString();
            $("#cves").append(
                // <option value="{{x.cve_id}}">{{x.cve_id}}</option>
                `<option value="`+ data.cves[i].cve_id +`">`+ data.cves[i].cve_id +`</option>`
            )

        }
        }
    });
    })


</script>







{% endblock content %}