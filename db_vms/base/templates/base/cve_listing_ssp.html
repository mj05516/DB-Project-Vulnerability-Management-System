{% extends "main.html" %}


{% load static %}


<style>
  #billdesc {
    padding-top: 50px;
  }

  #test {
    width: 100%;
    height: 30px;
  }

  option {
    height: 30px;
    line-height: 30px;
  }

  .editOption {
    width: 90%;
    height: 24px;
    position: relative;
    top: -30px
  }
</style>



{% block content %}
<div class="card mb-3 rounded-3" style="height: 7rem; justify-content: center; background-color: #197056;">
  <div class="row flex-between-end mx-2">
    <div class="col-auto align-self-center">
      <h2 class="mb-0" style="color: white">
        Common Vulnerabilities and Exposures (CVE) Listing
      </h2>
    </div>
  </div>
</div>

{% if messages %}
<ul class="messages p-0" style="position: inherit; top: 0; right: 0; z-index: 9999; width: 100%;">
  {% for message in messages %}
  <div class="alert alert-{{message.level_tag}} border-2 d-flex align-items-center shadow fade show" role="alert">
    <div class="bg-{{message.level_tag}} me-3 icon-item"><span class="{{message.extra_tags}}"></span>
    </div>
    <p class="mb-0 flex-1">{{ message }}</p>
    <button class="btn-close" type="button" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}
</ul>
{% endif %}


<div class="card border border-hbl">
  <div class="card-body">
    <table id="example" class="table table-sm table-striped rounded-3 fs--1 mb-0 overflow-hidden w-100">
      <thead class="bg-200 text-900">
        <tr style="background-color: #197056; color: white;">
          <th class="white-space-nowrap"></th>
          <th class="pe-1 align-middle ">ID</th>
          <th class="pe-1 align-middle" style="min-width: 6rem;">Date</th>
          <th class="pe-1 align-middle " style="min-width: 6rem;">Language</th>
          <th class="pe-1 align-middle " style="min-width: 4rem;">Score</th>
          <th class="pe-1 align-middle " style="min-width: 8rem;">Weekness Type</th>
          <!-- <th class="pe-1 align-middle white-space-nowrap "style="min-width: 6rem;">Solution</th> -->
          <th class="pe-1 align-middle " style="min-width: 4rem;">AC</th>
          <th class="pe-1 align-middle " style="min-width: 5rem;">UI</th>
          <th class="pe-1 align-middle " style="min-width: 4rem;">Avail.</th>
          <th class="pe-1 align-middle " style="min-width: 4rem;">Status</th>
          <!-- check if request.user is admin -->

          <th class="align-middle"> Options</th>

        </tr>
      </thead>
      <tbody class="list">

      </tbody>
    </table>
  </div>
</div>




<div class="modal fade" id="add-cve-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 50rem">
    <div class="modal-content position-relative">
      <div class="position-absolute top-0 end-0 mt-2 me-2 z-index-1">
      </div>
      <form action="{% url 'add_cve' %}" method="POST">
        {% csrf_token %}
        <div class="modal-body p-0">
          <div class="rounded-top-lg py-3 ps-4 pe-6 bg-light">
            <h4 class="mb-0 txt-hbl" id="modalExampleDemoLabel"><span class="fas fa-code me-3"></span>Add New CVE
            </h4>
          </div>
          <div class="p-4 pb-0">
            <div class="row g-3">
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="cve_id">CVE ID</label>
                  <input class="form-control" autocomplete="off" maxlength="150" id="cve_id" name="cve_id" type="text"
                    placeholder="Enter CVE ID" required />
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="language">Language</label>
                  <input class="form-control" id="language" name="language" type="text" placeholder="Enter CVE Language"
                    required />
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="score">Severity Score</label>
                  <!-- get float input 0.0 to 10.0 -->
                  <input class="form-control" id="score" name="score" type="number" step="0.1" min="0.0" max="10.0"
                    placeholder="Enter CVE Score" required />
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="solution">Solution</label>
                  <input class="form-control" id="solution" name="solution" type="text" placeholder="Enter CVE Solution"
                    required />
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="ac">Attack Complexity</label>
                  <select class="form-select" id="ac" name="ac" required>
                    <option value="HIGH">HIGH</option>
                    <option value="LOW">LOW</option>
                  </select>
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="ui">User Interaction</label>
                  <select class="form-select" id="ui" name="ui" required>
                    <option value="NONE">NONE</option>
                    <option value="REQUIRED">REQUIRED</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="availability">Availability</label>
                  <select class="form-select" id="availability" name="availability" required>
                    <option value="HIGH">HIGH</option>
                    <option value="LOW">LOW</option>
                    <option value="NONE">NONE</option>
                  </select>
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="status">Status</label>
                  <select class="form-select" id="status" name="status" required>
                    <option value="SOLVED">SOLVED</option>
                    <option value="UNSOLVED">UNSOLVED</option>
                    <option value="IN PROGRESS">IN PROGRESS</option>

                  </select>
                </div>
              </div>
            </div>
            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <!-- CVE Weekness type -->
                  <!-- <label class="form-label required" for="weekness_type">Weekness Type</label>
                    <input class="form-control" id="weekness_type" name="weekness_type" type="text" placeholder="Enter CVE Weekness Type" required /> -->
                  <label class="form-label required" for="weekness_type">Weekness Type</label>
                  <!-- <input id="autoComplete" class="form-control" type="text" name="myCountry" placeholder="Country"> -->
                  <input id="weekness_type" name="weekness_type" class="form-control"type="search" dir="ltr" spellcheck=false autocorrect="off" autocomplete="off"
                    autocapitalize="off">
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <!-- Textarea for CVE description -->
                  <label class="form-label required" for="description">Description</label>
                  <textarea class="form-control" id="description" name="description" rows="3"
                    placeholder="Enter CVE Description" required></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-sm btn-falcon-default me-1" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-sm btn-outline-hbl" type="submit">
            <span class="fas fa-code me-1"></span>Add CVE</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="edit-cve-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 50rem">
    <div class="modal-content position-relative">
      <div class="position-absolute top-0 end-0 mt-2 me-2 z-index-1">
      </div>
      <form action="{% url 'edit_cve' %}" method="POST">
        {% csrf_token %}
        <div class="modal-body p-0">
          <div class="rounded-top-lg py-3 ps-4 pe-6 bg-light">
            <h4 class="mb-0 txt-hbl" id="modalExampleDemoLabel"><span class="fas fa-code me-3"></span>Edit Existing CVE
            </h4>
          </div>
          <div class="p-4 pb-0">
            <div class="row g-3">
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="cve_id">CVE ID</label>
                  <input class="form-control" autocomplete="off" maxlength="150" id="cve_id" name="cve_id" type="text"
                    placeholder="Enter CVE ID" required readonly />
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="language">Language</label>
                  <input class="form-control" id="language" name="language" type="text" placeholder="Enter CVE Language"
                    required />
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="score">Severity Score</label>
                  <!-- get float input 0.0 to 10.0 -->
                  <input class="form-control" id="score" name="score" type="number" step="0.1" min="0.0" max="10.0"
                    placeholder="Enter CVE Score" required />
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="solution">Solution</label>
                  <input class="form-control" id="solution" name="solution" type="text" placeholder="Enter CVE Solution"
                    required />
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="ac">Attack Complexity</label>
                  <select class="form-select" id="ac" name="ac" required>
                    <option value="HIGH">HIGH</option>
                    <option value="LOW">LOW</option>
                  </select>
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="ui">User Interaction</label>
                  <select class="form-select" id="ui" name="ui" required>
                    <option value="NONE">NONE</option>
                    <option value="REQUIRED">REQUIRED</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="availability">Availability</label>
                  <select class="form-select" id="availability" name="availability" required>
                    <option value="HIGH">HIGH</option>
                    <option value="LOW">LOW</option>
                    <option value="NONE">NONE</option>
                  </select>
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label required" for="status">Status</label>
                  <select class="form-select" id="status" name="status" required>
                    <option value="SOLVED">SOLVED</option>
                    <option value="UNSOLVED">UNSOLVED</option>
                    <option value="IN PROGRESS">IN PROGRESS</option>

                  </select>
                </div>
              </div>
            </div>
            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <!-- CVE Weekness type -->
                  <!-- <label class="form-label required" for="weekness_type">Weekness Type</label>
                    <input class="form-control" id="weekness_type" name="weekness_type" type="text" placeholder="Enter CVE Weekness Type" required /> -->
                  <label class="form-label required" for="weekness_type">Weekness Type</label>
                  <input class="form-control" id="weekness_type" name="weekness_type" type="text"
                    placeholder="Enter CVE Weakness Type" />

                </div>
              </div>

            </div>

            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <!-- Textarea for CVE description -->
                  <label class="form-label required" for="description">Description</label>
                  <textarea class="form-control" id="description" name="description" rows="3"
                    placeholder="Enter CVE Description" required></textarea>
                </div>
              </div>

            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-sm btn-falcon-default me-1" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-sm btn-outline-hbl" type="submit">
            <span class="fas fa-code me-1"></span>Edit CVE</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="add-discussion-room-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 50rem">
    <div class="modal-content position-relative">
      <div class="position-absolute top-0 end-0 mt-2 me-2 z-index-1">
      </div>
      <form action="{% url 'add_room' %}" method="POST">
        {% csrf_token %}
        <div class="modal-body p-0">
          <div class="rounded-top-lg py-3 ps-4 pe-6 bg-light">
            <h4 class="mb-0 txt-hbl" id="modalExampleDemoLabel"><span class="fas fa-comments me-3"></span>Add New Room
            </h4>
          </div>
          <div class="p-4 pb-0">
            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label required" for="title">Room Title</label>
                  <input class="form-control" autocomplete="off" maxlength="150" id="title" name="title" type="text"
                    placeholder="Enter Room Title" required />
                </div>
              </div>

            </div>

            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <label for="topics">Topic</label>
                  <select class="form-select js-choice" id="topics" size="1" name="topics">
                    <option value="">Select Topic...</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <label for="members">Members</label>
                  <select class="form-select" id="members" multiple="multiple" size="1" name="members">
                  </select>
                </div>
              </div>
            </div>

            <!-- make one for cves -->
            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <label for="cves">CVEs</label>
                  <select class="form-select" id="cves" multiple="multiple" size="1" name="cves">
                  </select>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label required" for="description">Description</label>
                  <textarea class="form-control" id="description" name="description" rows="3"
                    placeholder="Enter Room Description" required></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-sm btn-falcon-default me-1" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-sm btn-outline-hbl" type="submit">
            <span class="fas fa-plus-circle me-1"></span>
            Create Room
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    $.ajax({
      url: "{% url 'fetch_users' %}",
      type: "GET",
      dataType: "json",
      success: function (data) {
        console.log(data['users']);
        for (var i = 0; i < data['users'].length; i++) {
          members_choices.setChoices([{
            value: data['users'][i][1],
            label: data['users'][i][0],
            selected: false,
          }], 'value', 'label', false);
        }
      },
      error: function (data) {
        console.log(data);
      }
    });

    $('#example').DataTable({
      "order": [
        [1, "asc"],
      ],
      "processing": true,
      "serverSide": true,
      "ajax": "{% url 'cve-listing-json' %}",
      "colReorder": true,
      "buttons": [
        {
          "className": "btn btn-sm btn-hbl py-2 {% if request.user.groups.all.0.name == 'Software Engineer'%} disabled {% endif %}",
          "text": "<span class='fas fa-plus me-1'></span>Add CVE",
          "action": function (e, dt, node, config) {
            $('#add-cve-modal').modal('show');
          }
        },
        {
          "className": "btn btn-sm btn-hbl py-2 {% if request.user.groups.all.0.name == 'Software Engineer'%} disabled {% endif %}",
          "text": "<span class='fas fa-trash me-1'></span>Delete CVE",
          "action": function (e, dt, node, config) {
            console.log("delete");
            var cve_ids = [];
            var table = $('#example').DataTable();
            var rows = table.rows('.selected').data();
            for (var i = 0; i < rows.length; i++) {
              console.log(rows[i][1]);
              cve_ids.push(rows[i][1]);
            }
            console.log(cve_ids);
            $.ajax({
              url: "{% url 'delete_multiple_cves' %}",
              type: "POST",
              data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                "cve_ids[]": cve_ids
              },
              success: function (data) {
                console.log(data);
                location.reload();
                // table.ajax.reload();
              },
              error: function (data) {
                console.log(data);
              }
            });
          }
        },
        {
          "className": "btn btn-sm btn-hbl py-2 {% if request.user.groups.all.0.name == 'Software Engineer'%} disabled {% endif %}",
          "text": "<span class='fas fa-comments me-1'></span>Add Discussion Room",
          "action": function (e, dt, node, config) {
            cve_choices.clearChoices();
            cve_choices.clearStore();

            console.log("add discussion room");
            var cve_ids = [];
            var cve_topics = [];
            var table = $('#example').DataTable();
            var rows = table.rows('.selected').data();
            for (var i = 0; i < rows.length; i++) {
              console.log(rows[i][5]);
              cve_ids.push(rows[i][1]);
              cve_topics.push(rows[i][5]);
            }
            console.log(cve_ids);
            for (var i = 0; i < cve_ids.length; i++) {
              cve_choices.setChoices([{
                value: cve_ids[i],
                label: cve_ids[i],
                selected: true,
              }], 'value', 'label', false);
            }

            var unique_topics = [...new Set(cve_topics)];
            console.log(unique_topics);
            for (var i = 0; i < unique_topics.length; i++) {
              topic_choices.setChoices([{
                value: unique_topics[i],
                label: unique_topics[i],
                selected: false,
              }], 'value', 'label', false);
            }
            $('#add-discussion-room-modal').modal('show');
          }
        },
        {
          "extend": "collection",
          "className": "btn btn-sm btn-hbl py-2",
          "text": '<span class="fas fa-download me-1"></span>Export',
          "buttons": ["copy", "csv", "excel", "pdf", "print"]
        }
      ],
      "searching": true,
      "language": {
        "searchPlaceholder": "Search Here",
        "search": "_INPUT_",
        "lengthMenu": "Show _MENU_ entries",
        "zeroRecords": "No matching records found",
        "infoEmpty": "No records available",
        "infoFiltered": "(filtered from _MAX_ total records)",
      },
      "pagingType": "simple_numbers",
      "lengthMenu": [
        [5, 10, 25, 50],
        [5, 10, 25, 50],
      ],
      "pageLength": 10,
      "select": {
        "style": "os",
        "selector": "td:first-child"
      },

      "columnDefs": [
        {
          "targets": [0],
          "orderable": false,
          "searchable": false,
          "className": "select-checkbox",
        },
        {
          "targets": [10],
          "orderable": false,
          "searchable": false,
        },
      ],
      "dom": '<"d-flex justify-content-between align-items-center mb-2"<"me-3"l><"d-flex align-items-center"<"me-3"f><"me-3"B>>>rt<"d-flex justify-content-between align-middle align-items-center mt-3"<"me-3"i><"me-3"p>>',
      "initComplete": function () {
        $('.dataTables_filter input[type="search"]').addClass('form-control form-control-sm py-2');
        $('.dataTables_paginate > .pagination').addClass('pagination-sm');
        $('.dataTables_length select').addClass('form-select form-select-sm py-2');
        $('.dataTables_wrapper .dataTables_length select').removeClass('form-select-sm');
        $('#checkbox').addClass('align-middle m-0');
        // remove thread with class bg-200 text-900
        // $('.bg-200.text-900').remove();
      }
    });
  });
</script>

<script>
  $(document).on('click', '.edit-cve', function () {
    var cve_id = $(this).attr('value');
    console.log(cve_id);
    $.ajax({
      url: "{% url 'fetch-cve' %}",
      type: "POST",
      data: {
        csrfmiddlewaretoken: '{{ csrf_token }}',
        cve_id: cve_id
      },
      success: function (data) {
        console.log(data);
        $('#edit-cve-modal #cve_id').val(data.cve_id);
        $('#edit-cve-modal #language').val(data.language);
        $('#edit-cve-modal #score').val(data.score);
        $('#edit-cve-modal #ac').val(data.attack_complexity);
        $('#edit-cve-modal #description').val(data.description);
        $('#edit-cve-modal #solution').val(data.solution);
        $('#edit-cve-modal #ui').val(data.user_interaction);
        $('#edit-cve-modal #availability').val(data.availability);
        $('#edit-cve-modal #status').val(data.status.toUpperCase());
        $('#edit-cve-modal #weekness_type').val(data.weakness_type);
        $('#edit-cve-modal').modal('show');
      },
      error: function (data) {
        console.log(data);
      }
    });
  });
</script>

<script>
  setTimeout(function () {
    $('.alert').alert('close');
  }, 5000);
</script>

<script>
  // document ready
</script>

<script>
  var cve_choices = new Choices('#cves', {
    removeItemButton: true,
    placeholder: true,
    placeholderValue: 'Select CVEs...',
    searchEnabled: true,
    searchChoices: true,
    allowHTML: true,
  });

  var topic_choices = new Choices('#topics', {
    removeItemButton: true,
    searchEnabled: true,
    searchChoices: true,
    placeholder: true,
    placeholderValue: 'Select Topics...',
    allowHTML: true,
    searchPlaceholderValue: 'Search Topics...',

  });

  var members_choices = new Choices('#members', {
    removeItemButton: true,
    searchEnabled: true,
    searchChoices: true,
    placeholder: true,
    placeholderValue: 'Select Members...',
    allowHTML: true,
    searchPlaceholderValue: 'Search Members...',
  });

  var weakness_type_choices = new Choices('#weekness_type', {
    searchEnabled: true,
    searchChoices: true,
    placeholder: true,
    placeholderValue: 'Select Weakness Type...',
    allowHTML: true,
    searchPlaceholderValue: 'Search Weakness Type...',
    addItems: true,
    addChoices: true,

  });
</script>

<script>
  const autoCompleteJS = new autoComplete({
    selector: "#weekness_type",
    placeHolder: "Enter Weakness Type",
    data: {
      src: async (query) => {
        try {
          const source = await fetch("{% url 'fetch_weakness_type' %}");
          const data = await source.json();
          return data;
        } catch (error) {
          return error;
        }
      },
    },
    resultItem: {
      highlight: true
    },
    events: {
      input: {
        selection: (event) => {
          const selection = event.detail.selection.value;
          autoCompleteJS.input.value = selection;
        }
      }
    }
  });
</script>
{% endblock content %}